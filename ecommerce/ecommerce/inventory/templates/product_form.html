{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="container mt-5">
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {{ form.as_p }}

        <div class="mb-3">
            <label for="id_files">Upload Images / Videos</label>
            <input type="file" id="id_files" name="file" multiple accept="image/*,video/*">
        </div>

        <div id="preview" class="d-flex flex-wrap gap-2">
            <!-- existing files -->
            {% for f in existing_files %}
            <div class="file-container" style="position: relative; width: 120px; height: 120px;" data-id="{{ f.id }}">
                <button type="button" class="btn-remove-existing"
                    style="position:absolute; top:0; right:0; background:red; color:white; border:none; cursor:pointer;">&times;</button>

                {% if ".mp4" in f.file.url|lower %}
                <video autoplay loop muted playsinline
                    style="border-radius: 8px; object-fit: cover;width:100%; height:100%" class="align-middle">
                    <source src="{{ f.file.url }}" type="video/mp4">
                </video>
                {% else %}
                <img src="{{ f.file.url }}" style="width:100%; height:100%; object-fit:cover">
                {% endif %}
            </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-success mt-3">Save</button>
    </form>

    <script>
        const input = document.getElementById('id_files');
        const preview = document.getElementById('preview');
        let deleteExisting = [];

        // remove old file
        preview.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove-existing')) {
                const container = e.target.closest('.file-container');
                const fileId = container.dataset.id;
                if (fileId) deleteExisting.push(fileId);
                container.remove();
            }
        });

        // preview new files
        input.addEventListener('change', () => {
            Array.from(input.files).forEach((file, index) => {
                const fileContainer = document.createElement('div');
                fileContainer.style.position = 'relative';
                fileContainer.style.width = '120px';
                fileContainer.style.height = '120px';

                const removeBtn = document.createElement('button');
                removeBtn.innerHTML = '&times;';
                removeBtn.style.position = 'absolute';
                removeBtn.style.top = '0';
                removeBtn.style.right = '0';
                removeBtn.style.background = 'red';
                removeBtn.style.color = 'white';
                removeBtn.style.border = 'none';
                removeBtn.style.cursor = 'pointer';
                removeBtn.addEventListener('click', () => {
                    const dt = new DataTransfer();
                    Array.from(input.files).forEach((f, i) => {
                        if (i !== index) dt.items.add(f);
                    });
                    input.files = dt.files;
                    fileContainer.remove();
                });

                if (file.type.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'cover';
                    fileContainer.appendChild(img);
                } else {
                    const video = document.createElement('video');
                    video.src = URL.createObjectURL(file);
                    video.controls = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    fileContainer.appendChild(video);
                }

                fileContainer.appendChild(removeBtn);
                preview.appendChild(fileContainer);
            });
        });

        // on submit, append delete_existing hidden inputs
        document.querySelector('form').addEventListener('submit', () => {
            deleteExisting.forEach(id => {
                const inputHidden = document.createElement('input');
                inputHidden.type = 'hidden';
                inputHidden.name = 'delete_files';
                inputHidden.value = id;
                document.querySelector('form').appendChild(inputHidden);
            });
        });
    </script>

</div>
{% endblock %}